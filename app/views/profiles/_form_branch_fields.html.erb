<%# Template for a single branch entry. Used both for existing records and as the template for new ones. %>
<%# When used as a template, field names use NEW_RECORD placeholder. %>
<%# When used for existing records, pass branch_form (fields_for object). %>

<div data-nested-fields-entry class="border border-gray-200 dark:border-slate-600 rounded-lg p-4 mb-4" data-controller="branch-city">
  <div class="flex justify-between items-start mb-3">
    <h3 class="text-sm font-medium text-gray-700 dark:text-slate-300"><%= branch_title %></h3>
    <% if paid_plan? %>
      <button type="button" data-action="nested-fields#remove" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 text-sm">Eliminar</button>
    <% end %>
  </div>

  <% if defined?(bf) && bf %>
    <%= bf.hidden_field :_destroy %>
    <%= bf.hidden_field :id if branch.persisted? %>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Nombre de la sucursal</label>
      <% if defined?(bf) && bf %>
        <%= bf.text_field :name, class: "w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white", required: true %>
      <% else %>
        <input type="text" name="doctor_profile[doctor_branches_attributes][NEW_RECORD][name]"
               class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white" required>
      <% end %>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Dirección</label>
      <% if defined?(bf) && bf %>
        <%= bf.text_field :address, class: "w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white", required: true %>
      <% else %>
        <input type="text" name="doctor_profile[doctor_branches_attributes][NEW_RECORD][address]"
               class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white" required>
      <% end %>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Departamento</label>
      <% if defined?(bf) && bf %>
        <%= bf.select :department_id,
                      options_for_select(@departments.map { |d| [d.name, d.id] }, branch.department_id),
                      { include_blank: "Selecciona un departamento" },
                      { class: "w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white",
                        data: { branch_city_target: "department", action: "change->branch-city#loadCities" } } %>
      <% else %>
        <select name="doctor_profile[doctor_branches_attributes][NEW_RECORD][department_id]"
                class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white"
                data-branch-city-target="department" data-action="change->branch-city#loadCities">
          <option value="">Selecciona un departamento</option>
          <% @departments.each do |d| %>
            <option value="<%= d.id %>"><%= d.name %></option>
          <% end %>
        </select>
      <% end %>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Ciudad</label>
      <% if defined?(bf) && bf %>
        <%= bf.select :city_id,
                      options_for_select(
                        (branch.department&.cities || @cities).map { |c| [c.name, c.id] },
                        branch.city_id
                      ),
                      { include_blank: "Selecciona una ciudad" },
                      { class: "w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white",
                        data: { branch_city_target: "city" } } %>
      <% else %>
        <select name="doctor_profile[doctor_branches_attributes][NEW_RECORD][city_id]"
                class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white"
                data-branch-city-target="city">
          <option value="">Selecciona una ciudad</option>
        </select>
      <% end %>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Enlace de mapa</label>
      <% if defined?(bf) && bf %>
        <%= bf.url_field :map_link, class: "w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white", placeholder: "https://maps.google.com/..." %>
      <% else %>
        <input type="url" name="doctor_profile[doctor_branches_attributes][NEW_RECORD][map_link]"
               class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white" placeholder="https://maps.google.com/...">
      <% end %>
    </div>

    <% if paid_plan? %>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Teléfono</label>
        <% if defined?(bf) && bf %>
          <%= bf.text_field :phone, class: "w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white" %>
        <% else %>
          <input type="text" name="doctor_profile[doctor_branches_attributes][NEW_RECORD][phone]"
                 class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white">
        <% end %>
      </div>
    <% end %>
  </div>

  <% if paid_plan? %>
    <%# Schedule section for paid plans %>
    <div class="mt-4 border-t border-gray-200 dark:border-slate-600 pt-4">
      <h4 class="text-sm font-medium text-gray-700 dark:text-slate-300 mb-3">Horarios de atención</h4>
      <div class="space-y-2">
        <% if defined?(bf) && bf %>
          <% BranchSchedule::DAY_NAMES.each do |day_num, day_name| %>
            <% schedule = branch.branch_schedules.detect { |s| s.day_of_week == day_num } || branch.branch_schedules.build(day_of_week: day_num) %>
            <%= bf.fields_for :branch_schedules, schedule, child_index: schedule.persisted? ? schedule.id : "#{day_num}_new" do |sf| %>
              <div class="flex items-center gap-3">
                <span class="w-24 text-sm text-gray-600 dark:text-slate-400"><%= day_name %></span>
                <%= sf.hidden_field :day_of_week %>
                <%= sf.hidden_field :id if schedule.persisted? %>
                <%= sf.time_field :opens_at, class: "px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white" %>
                <span class="text-gray-500 dark:text-slate-400">a</span>
                <%= sf.time_field :closes_at, class: "px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white" %>
                <label class="inline-flex items-center text-sm text-gray-500 dark:text-slate-400">
                  <%= sf.check_box :_destroy, { class: "rounded border-gray-300 dark:border-slate-600 dark:bg-slate-700" }, "1", "0" %> <span class="ml-1">Cerrado</span>
                </label>
              </div>
            <% end %>
          <% end %>
        <% else %>
          <% BranchSchedule::DAY_NAMES.each do |day_num, day_name| %>
            <div class="flex items-center gap-3">
              <span class="w-24 text-sm text-gray-600 dark:text-slate-400"><%= day_name %></span>
              <input type="hidden" name="doctor_profile[doctor_branches_attributes][NEW_RECORD][branch_schedules_attributes][<%= day_num %>][day_of_week]" value="<%= day_num %>">
              <input type="time" name="doctor_profile[doctor_branches_attributes][NEW_RECORD][branch_schedules_attributes][<%= day_num %>][opens_at]"
                     class="px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white">
              <span class="text-gray-500 dark:text-slate-400">a</span>
              <input type="time" name="doctor_profile[doctor_branches_attributes][NEW_RECORD][branch_schedules_attributes][<%= day_num %>][closes_at]"
                     class="px-2 py-1 border border-gray-300 dark:border-slate-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:text-white">
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
